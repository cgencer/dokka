server {
	listen				80;
	listen				[::]:80;
#    listen				[::]:443 ssl ipv6only=on; 	# managed by Certbot
    listen				443 ssl; 					# managed by Certbot

	server_name			akademi.piyononline.com www.akademi.piyononline.com akademi.localhost
						okul-1.piyononline.com okul-2.piyononline.com okul-3.piyononline.com 
						www.okul-1.piyononline.com www.okul-2.piyononline.com www.okul-3.piyononline.com;

	root 				/home/piyon/o2;

	access_log 			/var/log/nginx/akademi-o2.piyononline.com-access.log;
	error_log 			/var/log/nginx/akademi-o2.piyononline.com-error.log;

	index				index.php;
#	include				/etc/nginx/modules/security.conf;
#   include				/home/conf/letsencrypt.conf;	 	# managed by Certbot

#	include 			/etc/nginx/modules/fastcgi/fastcgi_drupal.conf;
#	include 			/etc/nginx/modules/drupal/drupal.conf;
#	include 			/etc/nginx/modules/drupal/drupal_cron_update.conf;

	if ($scheme != "https") {
		return 301 https://$host$request_uri;
	}

#    ssl_certificate /etc/letsencrypt/live/akademi.piyononline.com/fullchain.pem; # managed by Certbot
#    ssl_certificate_key /etc/letsencrypt/live/akademi.piyononline.com/privkey.pem; # managed by Certbot

	location / {
		try_files $uri /index.php?$query_string;
	}

	location @rewrite {
		rewrite ^/(.*)$ /index.php?q=$1;
	}

	location ~ /vendor/.*\.php$ {
		deny all;
		return 404;
	}

	location ~ ^/sites/.*/files/styles/ {
		try_files $uri @rewrite;
	}

	location ~ ^(/[a-z\-]+)?/system/files/ {
		try_files $uri /index.php?$query_string;
	}

	location ~ '\.php$|^/update.php' {
		fastcgi_split_path_info ^(.+?\.php)(|/.*)$;
#		include 		/etc/nginx/modules/fastcgi_params;
		# Block httpoxy attacks. See https://httpoxy.org/.
		fastcgi_param 	HTTP_PROXY "";
		fastcgi_param 	SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param 	PATH_INFO $fastcgi_path_info;
		fastcgi_param 	QUERY_STRING $query_string;
		fastcgi_intercept_errors on;
		fastcgi_pass 	unix:/var/run/php-fpm/php-fpm-70.sock;
	}
}
server {
    listen 	80;
	listen	[::]:80;
#    listen	[::]:443 ssl ipv6only=on; 	# managed by Certbot
    listen	443 ssl; 					# managed by Certbot

    server_name node.piyononline.com www.node.piyononline.com node.localhost;

#    ssl_certificate /etc/letsencrypt/live/akademi.piyononline.com/fullchain.pem; 	# managed by Certbot
#    ssl_certificate_key /etc/letsencrypt/live/akademi.piyononline.com/privkey.pem; 	# managed by Certbot

    location / {
        proxy_pass 			http://127.0.0.1:8765;
        proxy_http_version 	1.1;
        proxy_set_header 	Upgrade $http_upgrade;
        proxy_set_header 	Connection 'upgrade';
        proxy_set_header 	Host $host;
        proxy_cache_bypass 	$http_upgrade;
    }
}