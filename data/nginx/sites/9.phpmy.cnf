server {
	listen				80;
	listen				[::]:80;
	listen 				127.0.0.1:4443 ssl;

	server_name			lab.piyononline.com www.lab.piyononline.com;
	root 				/home/piyon/phpMyAdmin;

	index				index.php;
	include				/etc/nginx/modules/security.conf;

	location ~* \.(jpg|jpeg|gif|png|css|js|ico|htm|html|txt|xml)$ {
		access_log 		off;
		expires 		max;
	}

	location ~ /\.ht {
		deny all;
	}
	
	location = /favicon.ico {
        	log_not_found off;
        	access_log off;
	}

	location = /robots.txt {
	        allow all;
	        log_not_found off;
	        access_log off;
	}

	location ~ ^/sites/.*/private/ {
        	return 403;
	}

	location ~ ^/sites/[^/]+/files/.*\.php$ {
        	deny all;
	}

	location ~* ^/.well-known/ {
        	allow all;
	}

	location ~ (^|/)\. {
        	return 403;
	}

	location / {
        	try_files $uri /index.php;
    	}

	location ~ /vendor/.*\.php$ {
        	deny all;
        	return 404;
	}

	location ~ ^/sites/.*/files/styles/ {
        	try_files $uri @rewrite;
	}

	location ~ ^(/[a-z\-]+)?/system/files/ {
        	try_files $uri /index.php?$query_string;
	}

	location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        	try_files $uri @rewrite;
        	expires max;
        	log_not_found off;
	}

	location ~ '\.php$|^/update.php' {
	        fastcgi_split_path_info ^(.+?\.php)(|/.*)$;
	        include 	fastcgi_params;
	        # Block httpoxy attacks. See https://httpoxy.org/.
	        fastcgi_param 	HTTP_PROXY "";
	        fastcgi_param 	SCRIPT_FILENAME $document_root$fastcgi_script_name;
	        fastcgi_param 	PATH_INFO $fastcgi_path_info;
	        fastcgi_param 	QUERY_STRING $query_string;
	        fastcgi_intercept_errors on;
        	fastcgi_pass 	unix:/var/run/php-fpm/php-fpm-70.sock;
	}

    ssl_certificate /etc/letsencrypt/live/akademi.piyononline.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/akademi.piyononline.com/privkey.pem; # managed by Certbot

}
